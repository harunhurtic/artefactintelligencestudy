<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lillehammer Museum</title>
    <link rel="stylesheet" href="styling.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

</head>

<body>
    <div id="quiz-container">
    </div>

    <script>
        let userResponses = {};
        let deliveryPreference = "Text-Based";
        let audio = null;
        let participantId = "";  // Store participant ID
        let audioLoadTimeout = null;  // Global timeout tracker
        let controlsExpanded = true;  // Track expand/collapse state

        const questions = [
            {
                text: "How do you best engage with museum content? (1/7)", options: [
                    { answer: "Listening to guides, podcasts, or audio tours.", delivery: "Auditory" },
                    { answer: "Reading text panels, labels, and descriptions.", delivery: "Text-based" }
                ]
            },

            {
                text: "How often do you visit museums? (2/7)", options: [
                    { answer: "As often as I can. I love discovering new things.", score: 5, profile: "Explorer" },
                    { answer: "Occasionally, but mostly when I‚Äôm bringing someone along.", score: 7, profile: "Facilitator" },
                    { answer: "Regularly, especially when there‚Äôs a relevant exhibit to my interests.", score: 4, profile: "Professional/Hobbyist" },
                    { answer: "When I travel, museums are an essential part of the experience.", score: 6, profile: "Experience Seeker" },
                    { answer: "Whenever I need a peaceful, inspiring break.", score: 3, profile: "Recharger" }
                ]
            },
            {
                text: "What is your main reason for visiting a museum? (3/7)", options: [
                    { answer: "To discover and learn something new.", score: 3, profile: "Explorer" },
                    { answer: "To help someone else engage with exhibits and contents.", score: 4, profile: "Facilitator" },
                    { answer: "Because it aligns with my professional/hobby interests.", score: 5, profile: "Professional/Hobbyist" },
                    { answer: "Because it‚Äôs a must-see cultural experience.", score: 6, profile: "Experience Seeker" },
                    { answer: "To relax and enjoy a peaceful environment.", score: 7, profile: "Recharger" }
                ]
            },
            {
                text: "What‚Äôs the first thing you usually do in a museum? (4/7)", options: [
                    { answer: "Wander and explore whatever catches my attention.", score: 6, profile: "Explorer" },
                    { answer: "Make sure my companions are engaged and having a good time.", score: 3, profile: "Facilitator" },
                    { answer: "Go straight to the exhibits related to my field of interest", score: 4, profile: "Professional/Hobbyist" },
                    { answer: "Check out the most famous pieces or take a photo.", score: 5, profile: "Experience Seeker" },
                    { answer: "Find a quiet spot to take it all in.", score: 7, profile: "Recharger" }
                ]
            },
            {
                text: "What kind of museum exhibit excites you the most? (5/7)", options: [
                    { answer: "Hands-on, interactive, or unexpected discoveries.", score: 4, profile: "Explorer" },
                    { answer: "Exhibits designed for all ages to enjoy together.", score: 6, profile: "Facilitator" },
                    { answer: "Niche, highly detailed content that aligns with my passion.", score: 7, profile: "Professional/Hobbyist" },
                    { answer: "Immersive, visually striking, or social media-worthy exhibits.", score: 3, profile: "Experience Seeker" },
                    { answer: "Quiet, atmospheric, or contemplative spaces.", score: 5, profile: "Recharger" }
                ]
            },
            {
                text: "What would make a museum visit disappointing for you? (6/7)", options: [
                    { answer: "If there‚Äôs nothing new to explore or learn.", score: 7, profile: "Explorer" },
                    { answer: "If my companion(s) didn‚Äôt enjoy it.", score: 5, profile: "Facilitator" },
                    { answer: "If the exhibits didn‚Äôt go deep enough into the subject.", score: 6, profile: "Professional/Hobbyist" },
                    { answer: "If there were no 'wow' moments.", score: 3, profile: "Experience Seeker" },
                    { answer: "If it was too loud or crowded.", score: 4, profile: "Recharger" }
                ]
            },
            {
                text: "How do you usually feel after a museum visit? (7/7)", options: [
                    { answer: "Excited about what I discovered and eager to learn more.", score: 5, profile: "Explorer" },
                    { answer: "Happy that my group enjoyed it and learned something.", score: 7, profile: "Facilitator" },
                    { answer: "Inspired to apply what I saw to my work or hobbies.", score: 3, profile: "Professional/Hobbyist" },
                    { answer: "Satisfied that I‚Äôve checked off a great cultural experience.", score: 4, profile: "Experience Seeker" },
                    { answer: "Calm, refreshed, and maybe a little nostalgic.", score: 6, profile: "Recharger" }
                ]
            }
        ];

        const artefactDescriptions = {
            "Kinne": "Core staff with pinewood resin. The handle is grained, has two ears, and six black-painted hoops (wooden bands). The pinewood resin is cross-shaped at one end. The cross is painted brown and black. At the other end of the shaft and beneath the base, there is a carved cross.",
            "Handwritten Cookbook": "Handwritten cookbook with a thick cardboard cover. Spine made of thin leather, very cracked. In addition to handwritten recipes, there are some recipes from newspapers and magazines.",
            "Tinbox with a Hinged Lid": "Tinbox with a hinged lid. Rectangular shape with rounded corners. Green base color, with yellow and red print. There appear to be remnants of tape that once wrapped around the transition from the box to the lid."
        };

        function renderParticipantScreen() {
            let quizContainer = document.getElementById("quiz-container");

            if (!quizContainer) {
                console.error("‚ùå Error: quiz-container not found!");
                return;
            }

            quizContainer.innerHTML = `
        <div class="artefacts-container">
            <h1>Welcome to Lillehammer Museum üèõÔ∏è </h1>
            <h3>Enter the Participant ID to continue</h3>
            <input type="text" id="participant-input" placeholder="Enter Participant ID" style="font-size: 1.2em; padding: 10px; margin: 10px;">
            <button onclick="submitParticipantId()" class="nav-button">Start</button>
        </div>
    `;
        }

        function submitParticipantId() {
            const inputField = document.getElementById("participant-input");
            participantId = inputField.value.trim();

            if (!participantId) {
                alert("Please enter a valid Participant ID.");
                return;
            }

            console.log(`‚úÖ Participant ID set: ${participantId}`); // Log the ID for debugging
            renderQuiz();  // Proceed to the quiz
        }

        function renderQuiz() {
            let quizContainer = document.getElementById("quiz-container");

            if (!quizContainer) {
                console.error("‚ùå Error: quiz-container not found!");
                return;
            }

            quizContainer.innerHTML = `
    <div class="card">
        <h1 id="quiz-title">Welcome to Lillehammer Museum üèõÔ∏è </h1>
        <h3 id="pleaseAnswerQuestionsText">Please take a moment to answer a few questions so we can personalize your museum experience ‚ú®</h3>
    </div>
    <div id="quiz"></div>
    <h3 id="result"></h3>
`;

            renderQuestion(0); // Start the quiz with the first question
        }

        function renderQuestion(questionIndex) {
            const quizDiv = document.getElementById("quiz");
            quizDiv.innerHTML = ""; // Clear previous question

            if (questionIndex >= questions.length) {
                assignProfile(); // Skip final message, go straight to artefacts
                return;
            }

            const currentQuestion = questions[questionIndex];
            const questionDiv = document.createElement("div");
            questionDiv.className = "card";
            questionDiv.innerHTML = `<p>${currentQuestion.text}</p>`;

            const optionsContainer = document.createElement("div");
            optionsContainer.className = "options-container";

            let nextButtonCard = document.createElement("div");
            nextButtonCard.className = "card"; // Separate card for the "Next Question" button
            nextButtonCard.style.display = "none"; // Hidden until an answer is selected

            let nextButton = document.createElement("button");
            nextButton.className = "next-button";
            nextButton.innerText = "Next Question";
            nextButton.onclick = () => renderQuestion(questionIndex + 1);
            nextButtonCard.appendChild(nextButton);

            currentQuestion.options.forEach((option, optIndex) => {
                const button = document.createElement("button");
                button.className = "option-button";
                button.innerText = option.answer;
                button.onclick = () => selectAnswer(questionIndex, optIndex, button, nextButtonCard);

                optionsContainer.appendChild(button);
            });

            questionDiv.appendChild(optionsContainer);
            quizDiv.appendChild(questionDiv);
            quizDiv.appendChild(nextButtonCard); // Add the next button card (hidden initially)
        }

        function selectAnswer(questionIndex, optionIndex, selectedButton, nextButtonCard) {
            let selectedOption = questions[questionIndex].options[optionIndex];

            // Toggle selection: If already selected, remove the answer
            if (userResponses[questionIndex] === selectedOption) {
                delete userResponses[questionIndex]; // Remove answer
                selectedButton.classList.remove("selected"); // Remove highlight

                // Hide the "Next Question" card if no answer is selected
                nextButtonCard.style.display = "none";
                return;
            }

            // Store the selected answer
            userResponses[questionIndex] = selectedOption;

            // Update delivery preference if applicable
            if (selectedOption.delivery) {
                deliveryPreference = selectedOption.delivery;
                console.log(`‚úÖ Delivery Preference Updated: ${deliveryPreference}`);
            }

            // Remove "selected" class from all buttons in this question
            const optionButtons = document.querySelectorAll(".option-button");
            optionButtons.forEach(button => button.classList.remove("selected"));

            // Add "selected" class to the clicked button
            selectedButton.classList.add("selected");

            // Show the "Next Question" card after selecting an answer
            nextButtonCard.style.display = "block";
        }

        function checkCompletion() {
            if (Object.keys(userResponses).length === questions.length) {
                assignProfile();
            }
        }

        function assignProfile() {
            let scores = { "Explorer": 0, "Facilitator": 0, "Professional/Hobbyist": 0, "Experience Seeker": 0, "Recharger": 0 };

            Object.values(userResponses).forEach(response => {
                if (response.profile) {
                    scores[response.profile] += response.score;
                }
            });

            let assignedProfile = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);

            showArtefacts(assignedProfile); // Skip final message and go straight to artefacts
        }


        function clearSelections() {
            userResponses = {}; // Clear all stored responses
            deliveryPreference = "Text-Based"; // Reset delivery preference to default
            document.getElementById("result").innerHTML = ""; // Clear the result display
            renderQuiz(); // Re-render quiz with cleared state
        }

        function showArtefacts(profile) {
            // Stop audio when leaving the artefact page
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio = null;
            }

            // Get delivery preference
            let deliveryMode = deliveryPreference === "Auditory" ? "Auditory" : "Text-Based";

            document.getElementById("quiz-container").innerHTML = `
        <!-- Title/Profile Section -->
        <div class="artefacts-container">
            <h1>Lillehammer Museum - Artefacts</h1>
            <p><strong>Assigned Profile:</strong> ${profile}</p>
            <p><strong>Delivery:</strong> ${deliveryMode}</p>
            <button onclick="renderQuiz()" class="nav-button">üîÑ Change Preferences</button>
        </div>

        <!-- Artefacts Section -->
        <div class="artefacts-container">
            <h2>Select an Artefact:</h2>
            <div class="artefact-container">
                <button class="artefact-button" onclick='showArtefactDetails("Kinne", "${profile}")'>üßà Kinne</button>
                <button class="artefact-button" onclick='showArtefactDetails("Handwritten Cookbook", "${profile}")'>üìñ Handwritten Cookbook</button>
                <button class="artefact-button" onclick='showArtefactDetails("Tinbox with a Hinged Lid", "${profile}")'> üì¶ Tinbox with a Hinged Lid</button>
            </div>
        </div>
    `;
        }

        function showArtefactDetails(artefact, profile) {
            // Stop any ongoing audio when switching artefacts
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio = null;
            }

            document.getElementById("quiz-container").innerHTML = `
        <div class="artefacts-container">
            <button onclick="showArtefacts('${profile}')" class="back-button">‚¨ÖÔ∏è Back to Artefacts</button>
        </div>

        <div class="artefacts-container">
            <h2>${artefact}</h2>
            <p id="loading" class="loading">üîÑ Adapting description...</p>
            <p id="artefact-description" class="artefact-text"></p>
        </div>

        <!-- Sticky Audio Controls at the Bottom (Hidden Initially) -->
        <div id="sticky-audio-controls" class="sticky-audio-controls hidden">
    <button id="toggle-controls" onclick="toggleStickyControls()">‚¨áÔ∏è</button>
    <p id="audio-loading" class="loading" style="display: none;">üîä The narrator is getting ready...</p>
    <button id="playPauseButton" onclick="toggleAudio()" class="audio-button" style="display: none;">üîä Listen To Narration</button>
    <button id="moreInfoButton" onclick="requestMoreInfo('${artefact}', '${profile}')" class="audio-button" style="display: none;">üìú Tell Me More...</button>
</div>

    `;

            fetchOpenAITTS(artefact, profile);
        }


        function fetchOpenAITTS(artefact, profile) {
            let originalDescription = artefactDescriptions[artefact] || "No description available.";

            document.getElementById("loading").style.display = "block";
            document.getElementById("artefact-description").innerText = "";
            document.getElementById("audio-loading").style.display = "none";
            document.getElementById("playPauseButton").style.display = "none";
            document.getElementById("moreInfoButton").style.display = "none";
            document.getElementById("sticky-audio-controls").classList.add("hidden");

            fetch("https://artefactintelligencestudy.hurtic.net/fetch-description", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ artefact, originalDescription, profile, participantId }),
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("loading").style.display = "none";

                    if (!data.response || data.response.includes("The adaptation failed")) {
                        console.warn("‚ö†Ô∏è Adaptation failed, showing original description.");
                        document.getElementById("artefact-description").innerText =
                            `The adaptation failed. However, here's the original artefact description:\n\n${originalDescription}`;
                    } else {
                        document.getElementById("artefact-description").innerText = data.response;
                    }

                    // Show sticky controls after content is ready
                    setTimeout(() => {
                        document.getElementById("sticky-audio-controls").classList.remove("hidden");
                        document.getElementById("sticky-audio-controls").classList.add("visible");
                    }, 300);

                    if (deliveryPreference === "Auditory") {
                        document.getElementById("audio-loading").style.display = "block";
                        requestTTS(data.response, true);
                    } else {
                        document.getElementById("moreInfoButton").style.display = "block";
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error fetching description:", error);
                    document.getElementById("loading").style.display = "none";
                    document.getElementById("artefact-description").innerText =
                        `The adaptation failed. However, here's the original artefact description:\n\n${originalDescription}`;

                    setTimeout(() => {
                        document.getElementById("sticky-audio-controls").classList.remove("hidden");
                        document.getElementById("sticky-audio-controls").classList.add("visible");
                    }, 300);

                    document.getElementById("moreInfoButton").style.display = "block";
                });
        }

        function requestMoreInfo(artefact, profile) {
            if (!artefact || !profile || !participantId) {
                console.error("‚ùå Missing required fields: artefact, profile, or participantId");
                return;
            }

            // Stop any ongoing audio
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
                audio = null;
            }

            // Hide sticky controls while fetching data
            document.getElementById("sticky-audio-controls").classList.remove("visible");
            document.getElementById("sticky-audio-controls").classList.add("hidden");

            // Get button elements
            const playButton = document.getElementById("playPauseButton");
            const moreInfoButton = document.getElementById("moreInfoButton");
            const loadingIndicator = document.getElementById("audio-loading");

            // Hide all buttons immediately
            playButton.style.display = "none";
            moreInfoButton.style.display = "none";
            loadingIndicator.style.display = "none";

            document.getElementById("artefact-description").innerHTML = `<span class="loading">üîÑ Getting more details...</span>`;

            fetch("https://artefactintelligencestudy.hurtic.net/fetch-more-info", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ artefact, profile, participantId }),
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById("artefact-description").innerText = data.response;

                    // Re-show sticky controls after content loads
                    setTimeout(() => {
                        document.getElementById("sticky-audio-controls").classList.remove("hidden");
                        document.getElementById("sticky-audio-controls").classList.add("visible");
                    }, 300);

                    if (deliveryPreference === "Auditory") {
                        loadingIndicator.style.display = "block";
                        requestTTS(data.response, true);
                    } else {
                        moreInfoButton.style.display = "block";
                    }
                })
                .catch(error => {
                    console.error("‚ùå Error fetching more details:", error);
                    document.getElementById("artefact-description").innerText = "Failed to fetch additional information.";
                    moreInfoButton.style.display = "block";

                    setTimeout(() => {
                        document.getElementById("sticky-audio-controls").classList.remove("hidden");
                        document.getElementById("sticky-audio-controls").classList.add("visible");
                    }, 300);
                });
        }


        // Function to request TTS from server and buttons when loaded
        function requestTTS(text, isFromMoreInfo = false) {
            console.log(`üü° Sending TTS request (More Info: ${isFromMoreInfo})...`);

            fetch("https://artefactintelligencestudy.hurtic.net/fetch-tts", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text }),
            })
                .then(response => {
                    console.log("üü¢ Response received. Checking if valid...");
                    if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                    return response.blob();
                })
                .then(audioBlob => {
                    console.log("‚úÖ Audio file received. Creating URL...");
                    let audioURL = URL.createObjectURL(audioBlob);

                    if (audio) {
                        audio.pause();
                        audio.currentTime = 0;
                    }

                    audio = new Audio(audioURL);

                    let playButton = document.getElementById("playPauseButton");
                    let loadingIndicator = document.getElementById("audio-loading");
                    let moreInfoButton = document.getElementById("moreInfoButton");

                    // Hide buttons while waiting for audio
                    playButton.style.display = "none";
                    loadingIndicator.style.display = "block";
                    moreInfoButton.style.display = "none";

                    // Clear previous timeout if new request is made
                    if (audioLoadTimeout) clearTimeout(audioLoadTimeout);

                    // Show play button when audio is ready
                    audio.addEventListener("loadeddata", () => {
                        console.log("‚úÖ Audio loaded successfully!");
                        playButton.style.display = "block";
                        loadingIndicator.style.display = "none";
                        playButton.innerText = "üîä Listen To Narration";

                        if (isFromMoreInfo) {
                            moreInfoButton.style.display = "block";
                        }
                    });

                    // Timeout fallback if mobile delays "loadeddata"
                    audioLoadTimeout = setTimeout(() => {
                        if (playButton.style.display === "none") {
                            console.error("‚õî Audio still not loading after 5s. Showing button anyway.");
                            playButton.style.display = "block"; // Force show button if needed
                            loadingIndicator.style.display = "none";

                            if (isFromMoreInfo) {
                                moreInfoButton.style.display = "block";
                            }
                        }
                    }, 5000);

                    playButton.onclick = () => toggleAudio();
                    audio.onended = () => {
                        playButton.innerText = "üîä Listen To Narration";
                    };
                })
                .catch(error => {
                    console.error("‚ùå Error fetching TTS:", error);
                    document.getElementById("audio-loading").style.display = "none";
                    alert("Audio failed to load. Please try again.");
                });
        }

        async function playTTS(text) {
            try {
                let audioResponse = await fetch('BASE_URL/fetch-tts', {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ text }),
                });

                if (!audioResponse.ok) {
                    throw new Error(`Failed to generate audio: ${audioResponse.statusText}`);
                }

                // Create a URL for the audio file
                let audioBlob = await audioResponse.blob();
                let audioURL = URL.createObjectURL(audioBlob);

                // Stop any existing audio before playing a new one
                if (audio) {
                    audio.pause();
                    audio.currentTime = 0;
                }

                audio = new Audio(audioURL);
                document.getElementById("audio-loading").style.display = "none";
                document.getElementById("playPauseButton").style.display = "block";

                document.getElementById("playPauseButton").innerText = "‚è∏ Pause Narration";
                audio.play();

                audio.onended = () => {
                    document.getElementById("playPauseButton").innerText = "üîä Listen To Narration";
                };

            } catch (error) {
                console.error("Error playing TTS:", error);
                document.getElementById("audio-loading").style.display = "none";
            }
        }

        function toggleAudio() {
            if (!audio) return;

            let playButton = document.getElementById("playPauseButton");

            if (audio.paused) {
                audio.play().then(() => {
                    console.log("‚úÖ Audio started.");
                    playButton.innerText = "‚è∏ Pause Narration";
                }).catch(error => {
                    console.warn("‚ö†Ô∏è Audio play blocked, user interaction required.", error);
                });
            } else {
                audio.pause();
                playButton.innerText = "‚ñ∂Ô∏è Continue Narration";
            }
        }

        function toggleStickyControls() {
            const stickyControls = document.getElementById('sticky-audio-controls');
            const toggleButton = document.getElementById('toggle-controls');

            if (controlsExpanded) {
                // Collapse sticky controls
                stickyControls.classList.add('collapsed');
                toggleButton.innerText = '‚¨ÜÔ∏è';  // Change to up arrow
            } else {
                // Expand sticky controls
                stickyControls.classList.remove('collapsed');
                toggleButton.innerText = '‚¨áÔ∏è';  // Change to down arrow
            }

            controlsExpanded = !controlsExpanded;
        }


        function renderPreferences() {
            document.getElementById("quiz-container").innerHTML = `
                <h2>Update Your Preferences</h2>
                <div id="quiz"></div>
                <button onclick="showArtefacts(getAssignedProfile())" class="nav-button">‚û°Ô∏è Continue to Artefacts</button>
    `;

            renderQuiz(); // Re-render the questionnaire and restore previous selections
        }

        window.onload = renderParticipantScreen;

    </script>
</body>

</html>